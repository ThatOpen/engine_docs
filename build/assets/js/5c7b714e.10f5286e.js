"use strict";(self.webpackChunkengine_docs=self.webpackChunkengine_docs||[]).push([[4221],{3182:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>m,frontMatter:()=>s,metadata:()=>i,toc:()=>d});var o=t(4848),a=t(8453);const s={},r=void 0,i={id:"Tutorials/Components/Core/FragmentsManager",title:"FragmentsManager",description:'window.open("https://thatopen.github.io/engine_components/examples/FragmentsManager")} >Go Full Screen',source:"@site/docs/Tutorials/Components/Core/FragmentsManager.mdx",sourceDirName:"Tutorials/Components/Core",slug:"/Tutorials/Components/Core/FragmentsManager",permalink:"/Tutorials/Components/Core/FragmentsManager",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Clipper",permalink:"/Tutorials/Components/Core/Clipper"},next:{title:"Grids",permalink:"/Tutorials/Components/Core/Grids"}},l={},d=[{value:"\ud83d\udcc4 Managing Fragments Models",id:"-managing-fragments-models",level:2},{value:"\ud83d\udd96 Importing our Libraries",id:"-importing-our-libraries",level:3},{value:"\ud83c\udf0e Setting up a Simple Scene",id:"-setting-up-a-simple-scene",level:3},{value:"\u2728 Utilizing the FragmentsManager Component",id:"-utilizing-the-fragmentsmanager-component",level:3},{value:"\ud83d\uddc2\ufe0f Fragments List",id:"\ufe0f-fragments-list",level:3},{value:"\ud83d\udcc2 Loading Fragments Models",id:"-loading-fragments-models",level:3},{value:"\ud83c\udf81 Exporting the Fragments Model",id:"-exporting-the-fragments-model",level:3},{value:"\ud83d\uddd1\ufe0f Deleting Models",id:"\ufe0f-deleting-models",level:3},{value:"\ud83e\udde9 Adding some UI (optional but recommended)",id:"-adding-some-ui-optional-but-recommended",level:3},{value:"\u23f1\ufe0f Measuring the performance (optional)",id:"\ufe0f-measuring-the-performance-optional",level:3},{value:"\ud83c\udf89 Wrap up",id:"-wrap-up",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",hr:"hr",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{style:{position:"relative"},children:[(0,o.jsx)("iframe",{src:"https://thatopen.github.io/engine_components/examples/FragmentsManager"}),(0,o.jsx)("button",{class:"full-screen-btn",onClick:()=>window.open("https://thatopen.github.io/engine_components/examples/FragmentsManager"),children:"Go Full Screen"})]}),"\n",(0,o.jsx)(n.admonition,{title:"Source",type:"info",children:(0,o.jsxs)(n.p,{children:["Copying and pasting? We've got you covered! You can find the full source code of this tutorial ",(0,o.jsx)(n.a,{href:"https://github.com/ThatOpen/engine_components/blob/main/packages/core/src/fragments/FragmentsManager/example.ts",children:"here"}),"."]})}),"\n",(0,o.jsx)(n.h2,{id:"-managing-fragments-models",children:"\ud83d\udcc4 Managing Fragments Models"}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsxs)(n.p,{children:["In this tutorial, you'll learn how to load your BIM models in Fragment format. Fragment is an ",(0,o.jsx)(n.a,{href:"https://github.com/ThatOpen/engine_fragment/",children:"open source geometry system"})," that we created on top of ",(0,o.jsx)(n.a,{href:"https://threejs.org/",children:"Three.js"})," to display BIM models fast, while keeping control over the individual items of the model. The idea is simple: a BIM model is a FragmentsGroup, which is (like the name implies) a collection of fragments. A fragment is a set of identical geometries instantiated around the scene."]}),"\n",(0,o.jsx)(n.admonition,{title:"How do I get a BIM model in Fragment format?",type:"tip",children:(0,o.jsx)(n.p,{children:"The IfcLoader component does exactly that! It converts IFC models to Fragments. Check out that tutorial if you are starting out with IFC files. Of course, you can just use the IfcLoader in your app, but loading fragments is more than x10 faster than loading IFC files. Our recommendation is to convert your IFC files to fragments just once, store the fragment somewhere (frontent of backend) and then load the fragments instead of teh IFC models directly."})}),"\n",(0,o.jsx)(n.h3,{id:"-importing-our-libraries",children:"\ud83d\udd96 Importing our Libraries"}),"\n",(0,o.jsx)(n.p,{children:"First things first, let's install all necessary dependencies to make this example work:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'import Stats from "stats.js";\nimport * as BUI from "@thatopen/ui";\n// You have to import * as OBC from "@thatopen/components"\nimport * as OBC from "../..";\n'})}),"\n",(0,o.jsx)(n.h3,{id:"-setting-up-a-simple-scene",children:"\ud83c\udf0e Setting up a Simple Scene"}),"\n",(0,o.jsx)(n.p,{children:"To get started, let's set up a basic ThreeJS scene. This will serve as the foundation for our application and allow us to visualize the 3D models effectively:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const components = new OBC.Components();\n\nconst worlds = components.get(OBC.Worlds);\nconst world = worlds.create<\n  OBC.SimpleScene,\n  OBC.OrthoPerspectiveCamera,\n  OBC.SimpleRenderer\n>();\n\nworld.scene = new OBC.SimpleScene(components);\nworld.scene.setup();\nworld.scene.three.background = null;\n\nconst container = document.getElementById("container")!;\nworld.renderer = new OBC.SimpleRenderer(components, container);\nworld.camera = new OBC.OrthoPerspectiveCamera(components);\nawait world.camera.controls.setLookAt(78, 20, -2.2, 26, -4, 25);\n\ncomponents.init();\n\ncomponents.get(OBC.Grids).create(world);\n'})}),"\n",(0,o.jsx)(n.h3,{id:"-utilizing-the-fragmentsmanager-component",children:"\u2728 Utilizing the FragmentsManager Component"}),"\n",(0,o.jsxs)(n.p,{children:["Great! With the base viewer setup complete, let's dive into using the FragmentsManager component. This component serves as a convenient wrapper around the core FragmentsModels class from the ",(0,o.jsx)(n.code,{children:"@thatopen/fragments"})," library. One of the key advantages of using Fragments in That Open Engine is its worker-based architecture, which offloads most operations (data retrieval, visibility management, color adjustments, etc.) to a separate thread. This ensures that the app remains responsive during processing. To get started, the first step is to specify the URL of the Fragments worker:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'// One option, if you prefer not to rely on an external worker file,\n// is to copy the worker file into your project\'s public directory.\n// This ensures the worker file is bundled with your app during the build process,\n// and you can provide the corresponding path to it.\nconst githubUrl =\n  "https://thatopen.github.io/engine_fragment/resources/worker.mjs";\nconst fetchedUrl = await fetch(githubUrl);\nconst workerBlob = await fetchedUrl.blob();\nconst workerFile = new File([workerBlob], "worker.mjs", {\n  type: "text/javascript",\n});\nconst workerUrl = URL.createObjectURL(workerFile);\n'})}),"\n",(0,o.jsx)(n.p,{children:"Once initialization is complete, you can safely retrieve the component instance and proceed with its setup:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"const fragments = components.get(OBC.FragmentsManager);\nfragments.init(workerUrl);\n"})}),"\n",(0,o.jsx)(n.admonition,{title:"Manager Initialization",type:"tip",children:(0,o.jsx)(n.p,{children:"The initialization should only be performed once for the entire application instance."})}),"\n",(0,o.jsx)(n.p,{children:"Since the manager has already been initialized, we can proceed with its configuration. Fragments utilize culling and LOD (Level of Detail in 3D graphics, not LOD from BIM) to optimize geometry rendering by offloading parts that are not visible to the user. A common approach is to apply culling and LOD based on camera movements. By leveraging the world's camera controls, we can detect when the camera is about to stop moving (rest) and instruct the manager to update the visual state of all models accordingly:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'world.camera.controls.addEventListener("rest", () =>\n  fragments.core.update(true),\n);\n'})}),"\n",(0,o.jsx)(n.h3,{id:"\ufe0f-fragments-list",children:"\ud83d\uddc2\ufe0f Fragments List"}),"\n",(0,o.jsx)(n.p,{children:"When a model is loaded, it is added to memory and the manager's list. This list serves as a centralized place to manage all loaded fragments. Use it to detect when models are added or removed. Usually, that is used to tell the loaded model which camera to use for culling and LOD updates, and add it to the ThreeJS scene:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"fragments.list.onItemSet.add(({ value: model }) => {\n  model.useCamera(world.camera.three);\n  world.scene.three.add(model.object);\n  fragments.core.update(true);\n});\n"})}),"\n",(0,o.jsx)(n.h3,{id:"-loading-fragments-models",children:"\ud83d\udcc2 Loading Fragments Models"}),"\n",(0,o.jsx)(n.p,{children:"With the core setup complete, it's time to load a Fragments model into our scene. Fragments are optimized for fast loading and rendering, making them ideal for large-scale 3D models."}),"\n",(0,o.jsx)(n.admonition,{title:"Where can I find Fragment files?",type:"info",children:(0,o.jsx)(n.p,{children:"You can use the sample Fragment files available in our repository for testing. If you have an IFC model you'd like to convert to Fragments, check out the IfcImporter tutorial for detailed instructions."})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const loadFragments = async () => {\n  // you can provide as many files as you need\n  const fragPaths = [\n    "https://thatopen.github.io/engine_components/resources/frags/school_arq.frag",\n    "https://thatopen.github.io/engine_components/resources/frags/school_str.frag",\n  ];\n\n  // Promise.all loads models concurrently for faster execution.\n  await Promise.all(\n    fragPaths.map(async (path) => {\n      const modelId = path.split("/").pop()?.split(".").shift();\n      if (!modelId) return null;\n      const file = await fetch(path);\n      const buffer = await file.arrayBuffer();\n      // this is the main function to load the fragments\n      return fragments.core.load(buffer, { modelId });\n    }),\n  );\n};\n'})}),"\n",(0,o.jsx)(n.h3,{id:"-exporting-the-fragments-model",children:"\ud83c\udf81 Exporting the Fragments Model"}),"\n",(0,o.jsx)(n.p,{children:"At any point, you can download the models that have been loaded (although it may be unnecessary since you already have the original files used to load them). Exporting the models is straightforward and can be done as follows:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const downloadFragments = async () => {\n  for (const [, model] of fragments.list) {\n    const fragsBuffer = await model.getBuffer(false);\n    const file = new File([fragsBuffer], `${model.modelId}.frag`);\n    const link = document.createElement("a");\n    link.href = URL.createObjectURL(file);\n    link.download = file.name;\n    link.click();\n    URL.revokeObjectURL(link.href);\n  }\n};\n'})}),"\n",(0,o.jsx)(n.h3,{id:"\ufe0f-deleting-models",children:"\ud83d\uddd1\ufe0f Deleting Models"}),"\n",(0,o.jsx)(n.p,{children:"You can delete loaded models at any time to free up memory when they are no longer needed. Once a model is deleted, it is removed from memory and the fragments list. Deleting models is simple and can be done as follows:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"const deleteArchModel = () => {\n  const modelIds = [...fragments.list.keys()];\n  const modelId = modelIds.find((key) => /arq/.test(key));\n  if (!modelId) return;\n  fragments.core.disposeModel(modelId);\n};\n\nconst deleteAllModels = () => {\n  for (const [modelId] of fragments.list) {\n    fragments.core.disposeModel(modelId);\n  }\n};\n"})}),"\n",(0,o.jsx)(n.h3,{id:"-adding-some-ui-optional-but-recommended",children:"\ud83e\udde9 Adding some UI (optional but recommended)"}),"\n",(0,o.jsxs)(n.p,{children:["We will use the ",(0,o.jsx)(n.code,{children:"@thatopen/ui"})," library to add some simple and cool UI elements to our app. First, we need to call the ",(0,o.jsx)(n.code,{children:"init"})," method of the ",(0,o.jsx)(n.code,{children:"BUI.Manager"})," class to initialize the library:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"BUI.Manager.init();\n"})}),"\n",(0,o.jsx)(n.p,{children:"Now we will add some UI to play around with the actions in this tutorial. For more information about the UI library, you can check the specific documentation for it!"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const [panel, updatePanel] = BUI.Component.create<BUI.PanelSection, {}>((_) => {\n  const onLoadFragments = async ({ target }: { target: BUI.Button }) => {\n    target.loading = true;\n    await loadFragments();\n    target.loading = false;\n  };\n\n  let loadFragmentsBtn: BUI.TemplateResult | undefined;\n  if (fragments.list.size === 0) {\n    loadFragmentsBtn = BUI.html`\n      <bim-button label="Load fragments" @click=${onLoadFragments}></bim-button>\n    `;\n  }\n\n  let disposeArchModelBtn: BUI.TemplateResult | undefined;\n  if ([...fragments.list.keys()].some((key) => /arq/.test(key))) {\n    disposeArchModelBtn = BUI.html`\n      <bim-button label="Dispose Arch Model" @click=${deleteArchModel}></bim-button>\n      `;\n  }\n\n  let downloadFragmentsBtn: BUI.TemplateResult | undefined;\n  let disposeModelsBtn: BUI.TemplateResult | undefined;\n  if (fragments.list.size > 0) {\n    disposeModelsBtn = BUI.html`\n      <bim-button label="Dispose All Models" @click=${deleteAllModels}></bim-button>\n    `;\n\n    downloadFragmentsBtn = BUI.html`\n      <bim-button label="Export fragments" @click=${downloadFragments}></bim-button>\n    `;\n  }\n\n  return BUI.html`\n    <bim-panel active label="FragmentsManager Tutorial" class="options-menu">\n      <bim-panel-section label="Controls">\n        ${loadFragmentsBtn}\n        ${disposeArchModelBtn}\n        ${disposeModelsBtn}\n        ${downloadFragmentsBtn}\n      </bim-panel-section>\n    </bim-panel>\n  `;\n}, {});\n\nconst updateFunction = () => updatePanel();\nfragments.list.onItemSet.add(updateFunction);\nfragments.list.onItemDeleted.add(updateFunction);\n\ndocument.body.append(panel);\n'})}),"\n",(0,o.jsx)(n.p,{children:"And we will make some logic that adds a button to the screen when the user is visiting our app from their phone, allowing to show or hide the menu. Otherwise, the menu would make the app unusable."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const button = BUI.Component.create<BUI.PanelSection>(() => {\n  return BUI.html`\n      <bim-button class="phone-menu-toggler" icon="solar:settings-bold"\n        @click="${() => {\n          if (panel.classList.contains("options-menu-visible")) {\n            panel.classList.remove("options-menu-visible");\n          } else {\n            panel.classList.add("options-menu-visible");\n          }\n        }}">\n      </bim-button>\n    `;\n});\n\ndocument.body.append(button);\n'})}),"\n",(0,o.jsx)(n.h3,{id:"\ufe0f-measuring-the-performance-optional",children:"\u23f1\ufe0f Measuring the performance (optional)"}),"\n",(0,o.jsxs)(n.p,{children:["We'll use the ",(0,o.jsx)(n.a,{href:"https://github.com/mrdoob/stats.js",children:"Stats.js"})," to measure the performance of our app. We will add it to the top left corner of the viewport. This way, we'll make sure that the memory consumption and the FPS of our app are under control."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const stats = new Stats();\nstats.showPanel(2);\ndocument.body.append(stats.dom);\nstats.dom.style.left = "0px";\nstats.dom.style.zIndex = "unset";\nworld.renderer.onBeforeUpdate.add(() => stats.begin());\nworld.renderer.onAfterUpdate.add(() => stats.end());\n'})}),"\n",(0,o.jsx)(n.h3,{id:"-wrap-up",children:"\ud83c\udf89 Wrap up"}),"\n",(0,o.jsx)(n.p,{children:"That's it! Now you're able to load, manage, and interact with Fragments models in your application. Congratulations! Keep going with more tutorials in the documentation."})]})}function m(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>i});var o=t(6540);const a={},s=o.createContext(a);function r(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);