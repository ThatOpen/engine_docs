"use strict";(self.webpackChunkengine_docs=self.webpackChunkengine_docs||[]).push([[6020],{9181:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>m,frontMatter:()=>s,metadata:()=>i,toc:()=>c});var o=t(4848),a=t(8453);const s={},r=void 0,i={id:"Tutorials/Components/Core/Raycasters",title:"Raycasters",description:'window.open("https://thatopen.github.io/engine_components/examples/Raycasters")} >Go Full Screen',source:"@site/docs/Tutorials/Components/Core/Raycasters.mdx",sourceDirName:"Tutorials/Components/Core",slug:"/Tutorials/Components/Core/Raycasters",permalink:"/Tutorials/Components/Core/Raycasters",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"OrthoPerspectiveCamera",permalink:"/Tutorials/Components/Core/OrthoPerspectiveCamera"},next:{title:"ShadowedScene",permalink:"/Tutorials/Components/Core/ShadowedScene"}},l={},c=[{value:"\ud83d\udcc4 Picking With the Mouse",id:"-picking-with-the-mouse",level:2},{value:"\ud83d\udd96 Importing our Libraries",id:"-importing-our-libraries",level:3},{value:"\ud83c\udf0e Setting up a Simple Scene",id:"-setting-up-a-simple-scene",level:3},{value:"\ud83d\udee0\ufe0f Setting Up Fragments",id:"\ufe0f-setting-up-fragments",level:3},{value:"\ud83d\udcc2 Loading Fragments Models",id:"-loading-fragments-models",level:3},{value:"\u2728 Using The Raycasters Component",id:"-using-the-raycasters-component",level:3},{value:"\ud83e\udde9 Adding some UI (optional but recommended)",id:"-adding-some-ui-optional-but-recommended",level:3},{value:"\u23f1\ufe0f Measuring the performance (optional)",id:"\ufe0f-measuring-the-performance-optional",level:3},{value:"\ud83c\udf89 Wrap up",id:"-wrap-up",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",hr:"hr",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{style:{position:"relative"},children:[(0,o.jsx)("iframe",{src:"https://thatopen.github.io/engine_components/examples/Raycasters"}),(0,o.jsx)("button",{class:"full-screen-btn",onClick:()=>window.open("https://thatopen.github.io/engine_components/examples/Raycasters"),children:"Go Full Screen"})]}),"\n",(0,o.jsx)(n.admonition,{title:"Source",type:"info",children:(0,o.jsxs)(n.p,{children:["Copying and pasting? We've got you covered! You can find the full source code of this tutorial ",(0,o.jsx)(n.a,{href:"https://github.com/ThatOpen/engine_components/blob/main/packages/core/src/core/Raycasters/example.ts",children:"here"}),"."]})}),"\n",(0,o.jsx)(n.h2,{id:"-picking-with-the-mouse",children:"\ud83d\udcc4 Picking With the Mouse"}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.p,{children:"Ray casting is the process of casting a ray from a point in space to another point in space. We will cast a ray from the mouse position to the 3D world and check if there is an object in its way. That way, when you hover or click on an object, we can know which one it is and do something with it. In this tutorial you'll learn how to use the Raycaster to pick objects in the scene with the mouse."}),"\n",(0,o.jsx)(n.h3,{id:"-importing-our-libraries",children:"\ud83d\udd96 Importing our Libraries"}),"\n",(0,o.jsx)(n.p,{children:"First things first, let's install all necessary dependencies to make this example work:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'import * as FRAGS from "@thatopen/fragments";\nimport * as THREE from "three";\nimport Stats from "stats.js";\nimport * as BUI from "@thatopen/ui";\n// You have to import * as OBC from "@thatopen/components"\nimport * as OBC from "../..";\n'})}),"\n",(0,o.jsx)(n.h3,{id:"-setting-up-a-simple-scene",children:"\ud83c\udf0e Setting up a Simple Scene"}),"\n",(0,o.jsx)(n.p,{children:"To get started, let's set up a basic ThreeJS scene. This will serve as the foundation for our application and allow us to visualize the 3D models effectively:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const components = new OBC.Components();\n\nconst worlds = components.get(OBC.Worlds);\nconst world = worlds.create<\n  OBC.SimpleScene,\n  OBC.OrthoPerspectiveCamera,\n  OBC.SimpleRenderer\n>();\n\nworld.scene = new OBC.SimpleScene(components);\nworld.scene.setup();\nworld.scene.three.background = null;\n\nconst container = document.getElementById("container")!;\nworld.renderer = new OBC.SimpleRenderer(components, container);\nworld.camera = new OBC.OrthoPerspectiveCamera(components);\nawait world.camera.controls.setLookAt(68, 23, -8.5, 21.5, -5.5, 23);\n\ncomponents.init();\n'})}),"\n",(0,o.jsx)(n.h3,{id:"\ufe0f-setting-up-fragments",children:"\ud83d\udee0\ufe0f Setting Up Fragments"}),"\n",(0,o.jsx)(n.p,{children:"Now, let's configure the FragmentsManager. This will allow us to load models effortlessly and start manipulating them with ease:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const workerUrl =\n  "https://thatopen.github.io/engine_fragment/resources/worker.mjs";\nconst fragments = components.get(OBC.FragmentsManager);\nfragments.init(workerUrl);\n\nworld.camera.controls.addEventListener("rest", () =>\n  fragments.core.update(true),\n);\n\nworld.onCameraChanged.add((camera) => {\n  for (const [, model] of fragments.list) {\n    model.useCamera(camera.three);\n  }\n  fragments.core.update(true);\n});\n\nfragments.list.onItemSet.add(({ value: model }) => {\n  model.useCamera(world.camera.three);\n  world.scene.three.add(model.object);\n  fragments.core.update(true);\n});\n'})}),"\n",(0,o.jsx)(n.h3,{id:"-loading-fragments-models",children:"\ud83d\udcc2 Loading Fragments Models"}),"\n",(0,o.jsx)(n.p,{children:"With the core setup complete, it's time to load a Fragments model into our scene. Fragments are optimized for fast loading and rendering, making them ideal for large-scale 3D models."}),"\n",(0,o.jsx)(n.admonition,{title:"Where can I find Fragment files?",type:"info",children:(0,o.jsx)(n.p,{children:"You can use the sample Fragment files available in our repository for testing. If you have an IFC model you'd like to convert to Fragments, check out the IfcImporter tutorial for detailed instructions."})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const fragPaths = ["https://thatopen.github.io/engine_components/resources/frags/school_arq.frag"];\nawait Promise.all(\n  fragPaths.map(async (path) => {\n    const modelId = path.split("/").pop()?.split(".").shift();\n    if (!modelId) return null;\n    const file = await fetch(path);\n    const buffer = await file.arrayBuffer();\n    return fragments.core.load(buffer, { modelId });\n  }),\n);\n'})}),"\n",(0,o.jsx)(n.h3,{id:"-using-the-raycasters-component",children:"\u2728 Using The Raycasters Component"}),"\n",(0,o.jsx)(n.p,{children:"With the model now loaded, we can leverage the raycaster to pick items in the scene. Let's retrieve the raycaster as shown below:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"const casters = components.get(OBC.Raycasters);\n// Each raycaster is associated with a specific world.\n// Here, we retrieve the raycaster for the `world` used in our scene.\nconst caster = casters.get(world);\n"})}),"\n",(0,o.jsx)(n.p,{children:"With the world caster available, we can cast a ray under any condition we choose. In this example, we'll perform a raycast each time the user double-clicks within the viewer container."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'// We set a selection callback, so we can decide what\n// happen with the selected element later\nlet onSelectCallback = (_modelIdMap: OBC.ModelIdMap) => {};\n\ncontainer.addEventListener("dblclick", async () => {\n  const result = (await caster.castRay()) as any;\n  if (!result) return;\n  // The modelIdMap is how selections are represented in the engine.\n  // The keys are modelIds, while the values are sets of localIds (items within the model)\n  const modelIdMap = { [result.fragments.modelId]: new Set([result.localId]) };\n  onSelectCallback(modelIdMap);\n});\n'})}),"\n",(0,o.jsx)(n.p,{children:"Now, for added functionality, let's modify the color of the selected element by reassigning the selection callback to something more useful. Additionally, we'll store the attributes of the selected element in a variable that can be utilized to display information (like the Name) in the UI for this example."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'let onItemSelected = () => {};\nlet attributes: FRAGS.ItemData | undefined;\n\n// We set the color outside just to be able to change it from the UI\nconst color = new THREE.Color("purple");\n\nonSelectCallback = async (modelIdMap) => {\n  const modelId = Object.keys(modelIdMap)[0];\n  if (modelId && fragments.list.get(modelId)) {\n    const model = fragments.list.get(modelId)!;\n    const [data] = await model.getItemsData([...modelIdMap[modelId]]);\n    attributes = data;\n  }\n\n  await fragments.highlight(\n    {\n      color,\n      renderedFaces: FRAGS.RenderedFaces.ONE,\n      opacity: 1,\n      transparent: false,\n    },\n    modelIdMap,\n  );\n\n  await fragments.core.update(true);\n\n  onItemSelected();\n};\n'})}),"\n",(0,o.jsx)(n.admonition,{title:"Attention!",type:"warning",children:(0,o.jsxs)(n.p,{children:["In this example, we are directly using ",(0,o.jsx)(n.code,{children:"fragments.highlight"})," for demonstration purposes. However, the recommended approach is to utilize the Highlighter component. Please refer to the corresponding tutorial for detailed instructions."]})}),"\n",(0,o.jsx)(n.h3,{id:"-adding-some-ui-optional-but-recommended",children:"\ud83e\udde9 Adding some UI (optional but recommended)"}),"\n",(0,o.jsxs)(n.p,{children:["We will use the ",(0,o.jsx)(n.code,{children:"@thatopen/ui"})," library to add some simple and cool UI elements to our app. First, we need to call the ",(0,o.jsx)(n.code,{children:"init"})," method of the ",(0,o.jsx)(n.code,{children:"BUI.Manager"})," class to initialize the library:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"BUI.Manager.init();\n"})}),"\n",(0,o.jsx)(n.p,{children:"Now we will add some UI to play around with the actions in this tutorial. For more information about the UI library, you can check the specific documentation for it!"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const [panel, updatePanel] = BUI.Component.create<BUI.PanelSection, {}>((_) => {\n  const onColorChange = ({ target }: { target: BUI.ColorInput }) => {\n    color.set(target.color);\n  };\n\n  let nameLabel = BUI.html`<bim-label>There is no item name to display.</bim-label>`;\n  if (attributes && "value" in attributes.Name) {\n    nameLabel = BUI.html`<bim-label>${attributes.Name.value}</bim-label>`;\n  }\n\n  const onClearColors = async ({ target }: { target: BUI.Button }) => {\n    target.loading = true;\n    await fragments.resetHighlight();\n    await fragments.core.update(true);\n    target.loading = false;\n  };\n\n  return BUI.html`\n    <bim-panel active label="Raycasters Tutorial" class="options-menu">\n      <bim-panel-section label="Controls">\n        <bim-label>Double Click: Colorize element</bim-label>\n        <bim-color-input @input=${onColorChange} color=#${color.getHexString()}></bim-color-input>\n        <bim-button label="Clear Colors" @click=${onClearColors}></bim-button>\n      </bim-panel-section>\n      <bim-panel-section label="Item Data">\n        ${nameLabel}\n      </bim-panel-section>\n    </bim-panel>\n  `;\n}, {});\n\nonItemSelected = () => updatePanel();\n\ndocument.body.append(panel);\n'})}),"\n",(0,o.jsx)(n.p,{children:"And we will make some logic that adds a button to the screen when the user is visiting our app from their phone, allowing to show or hide the menu. Otherwise, the menu would make the app unusable."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const button = BUI.Component.create<BUI.PanelSection>(() => {\n  return BUI.html`\n      <bim-button class="phone-menu-toggler" icon="solar:settings-bold"\n        @click="${() => {\n          if (panel.classList.contains("options-menu-visible")) {\n            panel.classList.remove("options-menu-visible");\n          } else {\n            panel.classList.add("options-menu-visible");\n          }\n        }}">\n      </bim-button>\n    `;\n});\n\ndocument.body.append(button);\n'})}),"\n",(0,o.jsx)(n.h3,{id:"\ufe0f-measuring-the-performance-optional",children:"\u23f1\ufe0f Measuring the performance (optional)"}),"\n",(0,o.jsxs)(n.p,{children:["We'll use the ",(0,o.jsx)(n.a,{href:"https://github.com/mrdoob/stats.js",children:"Stats.js"})," to measure the performance of our app. We will add it to the top left corner of the viewport. This way, we'll make sure that the memory consumption and the FPS of our app are under control."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const stats = new Stats();\nstats.showPanel(2);\ndocument.body.append(stats.dom);\nstats.dom.style.left = "0px";\nstats.dom.style.zIndex = "unset";\nworld.renderer.onBeforeUpdate.add(() => stats.begin());\nworld.renderer.onAfterUpdate.add(() => stats.end());\n'})}),"\n",(0,o.jsx)(n.h3,{id:"-wrap-up",children:"\ud83c\udf89 Wrap up"}),"\n",(0,o.jsx)(n.p,{children:"That's it! Now you're able to pick objects in the scene using raycasting. Congratulations! Keep exploring more tutorials in the documentation to enhance your skills further."})]})}function m(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>i});var o=t(6540);const a={},s=o.createContext(a);function r(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);