"use strict";(self.webpackChunkengine_docs=self.webpackChunkengine_docs||[]).push([[9359],{6313:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>l});var s=t(4848),r=t(8453);const o={sidebar_position:3},i="\ud83e\uddf9 Keeping them clean",a={id:"components/clean-components-guide",title:"\ud83e\uddf9 Keeping them clean",description:"\ud83e\uddfd Basics",source:"@site/docs/components/clean-components-guide.md",sourceDirName:"components",slug:"/components/clean-components-guide",permalink:"/components/clean-components-guide",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"\ud83e\uddbe Making your own",permalink:"/components/creating-components"},next:{title:"\ud83e\udded Tutorial paths",permalink:"/components/tutorial-paths"}},c={},l=[{value:"\ud83e\uddfd Basics",id:"-basics",level:2},{value:"\ud83e\uddfc TypeScript",id:"-typescript",level:2},{value:"\ud83d\udcda Documentation",id:"-documentation",level:2},{value:"\ud83e\udde0 Memory management",id:"-memory-management",level:2},{value:"\ud83e\udd4e 3D objects and materials",id:"-3d-objects-and-materials",level:3},{value:"\ud83d\udcc5 Events",id:"-events",level:3},{value:"\ud83d\udc18 Huge objects / arrays",id:"-huge-objects--arrays",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"-keeping-them-clean",children:"\ud83e\uddf9 Keeping them clean"}),"\n",(0,s.jsx)(n.h2,{id:"-basics",children:"\ud83e\uddfd Basics"}),"\n",(0,s.jsxs)(n.p,{children:["Always extend from the base ",(0,s.jsx)(n.code,{children:"Component"})," class. \ud83d\udc6a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:'import * as OBC from "@thatopen/components"\r\n\r\nexport MyComponent extends OBC.Component {\r\n\t// ...\r\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Always name the ",(0,s.jsx)(n.strong,{children:"base file"})," of your component ",(0,s.jsx)(n.code,{children:"index.ts"})," and store it in ",(0,s.jsx)(n.strong,{children:"a folder with the component name"}),". If you need to include other supporting files, create a ",(0,s.jsx)(n.code,{children:"src"})," folder in the component folder. You can call those supporting file whatever you want. The folder should have another ",(0,s.jsx)(n.code,{children:"index.ts"})," file exporting all the elements that have to be exported from the folder. This is a basic folder structure: \ud83d\uddc3\ufe0f"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["MyComponent","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"index.ts"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"src"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"supporting-file-1.ts"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"supporting-file-2.ts"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"index.ts"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"-typescript",children:"\ud83e\uddfc TypeScript"}),"\n",(0,s.jsxs)(n.p,{children:["Follow the ",(0,s.jsx)(n.strong,{children:"Single Responsibility Principle"}),". \ud83e\udd47"]}),"\n",(0,s.jsxs)(n.p,{children:["Always name private members with ",(0,s.jsx)(n.strong,{children:"underscore"}),". \ud83e\udd77\ud83c\udffb"]}),"\n",(0,s.jsxs)(n.p,{children:["Avoid using ",(0,s.jsx)(n.code,{children:"!"})," in property fields. If a property element is not initialized in the constructor, you can either use ",(0,s.jsx)(n.code,{children:"?"}),", or ",(0,s.jsx)(n.strong,{children:"create a getter"})," to assert that it exists before getting it, like this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:'private _customProperty?: string;\r\n\r\nget customProperty(): string { \r\n\tif(!this._customProperty) {\r\n\t\tthrow new Error("Custom property not initialized!");\r\n\t}\r\n\treturn this._customProperty;\r\n }\r\n\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Avoid using ",(0,s.jsx)(n.code,{children:"any"})," as much as possible. \u274c"]}),"\n",(0,s.jsxs)(n.p,{children:["Never define private properties in the constructor. ",(0,s.jsx)(n.strong,{children:"Make them explicit"})," beforehand: \ud83d\udccb"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"/*Incorrect*/\r\nconstructor(private _components: Components)\r\n\r\n/*Correct*/\r\nprivate _components: Components\r\nconstructor(components: Components) {\r\n\tthis._components = components;\r\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Always ",(0,s.jsx)(n.strong,{children:"make events readonly"})," and initialize them directly. \u26a1"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-jsx",children:"readonly onCreated = new OBC.Event<number>()\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Always make sure to ",(0,s.jsx)(n.strong,{children:"know the interfaces"})," you can implement when creating your component (i.e. ",(0,s.jsx)(n.code,{children:"Creatable"}),", ",(0,s.jsx)(n.code,{children:"Hideable"}),", ",(0,s.jsx)(n.code,{children:"UI"}),", etc), that way we keep things uniform in terms of properties and methods naming and types."]}),"\n",(0,s.jsx)(n.h2,{id:"-documentation",children:"\ud83d\udcda Documentation"}),"\n",(0,s.jsxs)(n.p,{children:["In tutorials, ",(0,s.jsx)(n.strong,{children:"try to not reference specifics"})," inside paragraphs. That allows to easily update the tutorial code without need to also update the paragraphs. \ud83d\udc47\ud83c\udffb"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"/*\u274c Incorrect */\r\n/*MD\r\nTo add a cube to the scene, you need to call scene.add()\r\n*/\r\n\r\nscene.add(cube)\r\n\r\n/*\u2705 Correct*/\r\n/*MD\r\nTo add a cube to the scene, just add the following code line!\r\n*/\r\n\r\nscene.add(cube)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"-memory-management",children:"\ud83e\udde0 Memory management"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Memory management is critical"})," when using Open BIM components. Not paying attention to this can result in applications that consume more and more memory, up to a point in which it ",(0,s.jsx)(n.strong,{children:"freezes / crashes"}),". This is especially relevant when using SPA (Single Page Application) libraries and frameworks, like ",(0,s.jsx)(n.strong,{children:"React"}),", ",(0,s.jsx)(n.strong,{children:"Angular"}),", ",(0,s.jsx)(n.strong,{children:"Vue"}),", etc. \ud83d\uded1"]}),"\n",(0,s.jsxs)(n.p,{children:["To make sure your component ",(0,s.jsx)(n.strong,{children:"doesn\u2019t cause memory leaks"})," and stays efficient, you need to make sure that:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["It is added to the ",(0,s.jsx)(n.code,{children:"components"})," instance in the constructor like specified in the ",(0,s.jsx)(n.a,{href:"/components/creating-components#-create-it",children:"component creation guide"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["It implements the ",(0,s.jsx)(n.code,{children:"Disposable"})," interface. This will force you to implement a ",(0,s.jsx)(n.code,{children:"dispose()"})," method that will be called automatically by the library when ",(0,s.jsx)(n.code,{children:"components.dispose()"})," is called. You can ",(0,s.jsx)(n.strong,{children:"add all the clean up logic inside this method"}),". You also need to add a ",(0,s.jsx)(n.code,{children:"onDisposed"})," event so that you can subscribe to the deletion of that component to clean up."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["There are some things that you want to clean up inside the ",(0,s.jsx)(n.code,{children:"dispose"})," method:"]}),"\n",(0,s.jsx)(n.h3,{id:"-3d-objects-and-materials",children:"\ud83e\udd4e 3D objects and materials"}),"\n",(0,s.jsxs)(n.p,{children:["Three.js needs to ",(0,s.jsx)(n.a,{href:"https://threejs.org/docs/#manual/en/introduction/How-to-dispose-of-objects",children:"manually release the memory"})," of the ",(0,s.jsx)(n.strong,{children:"geometry"})," and ",(0,s.jsx)(n.strong,{children:"materials"})," that are not used anymore. If your component creates any new geometry or material, you need to keep track of it and get rid of it. You can do this in 2 ways:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\ud83e\uddf9 Using the Three.js ",(0,s.jsx)(n.code,{children:"dispose"})," method to ",(0,s.jsx)(n.strong,{children:"delete all geometries and materials"}),", including their children."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\ud83e\uddf9 Using the ",(0,s.jsx)(n.code,{children:"Disposer"})," component provided by the components library, which ",(0,s.jsx)(n.strong,{children:"does everything for you"}),"."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["To make sure that the browser gets rid of this memory, you should also ",(0,s.jsx)(n.strong,{children:"leave this data out of scope"})," (e.g. emptying the array where they are after disposing it). For instance, if you are keeping track of all your meshes in an array called ",(0,s.jsx)(n.code,{children:"meshes"}),", you can get rid of it like this: \ud83d\udc47\ud83c\udffb"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:'import * as THREE from "three";\r\nimport * as OBC from "@thatopen/components";\r\n\r\nclass YourComponent extends Component implements Disposable {\r\n\r\n\t// ...\r\n\r\n\treadonly onDisposed = new OBC.Event();\r\n\r\n\tprivate _meshes: Mesh[];\r\n\r\n\tdispose() {\r\n\t\t// ...\r\n\t\tconst disposer = this.components.get(OBC.Disposer);\r\n\t\tfor(const mesh of this.meshes) {\r\n\t\t\t// The disposer gets rid of geometries and materials\r\n\t\t\t// including children\r\n\t\t\tdisposer.dispose(mesh);\r\n\t\t}\r\n\t\t// Removing all references to them\r\n\t\t// in arrays an object is critical for this to work\r\n\t\tthis._meshes = [];\r\n\t\tthis.onDisposed.trigger();\r\n\t\tthis.onDisposed.reset();\r\n\t}\r\n\r\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"-events",children:"\ud83d\udcc5 Events"}),"\n",(0,s.jsxs)(n.p,{children:["Events are a nice way of ",(0,s.jsx)(n.strong,{children:"binding HTML elements to JS logic"}),". A common way of doing that is using ",(0,s.jsx)(n.code,{children:"addEventListener"}),". That\u2019s fine if all the events are bound to HTML elements that you create inside your component and ",(0,s.jsx)(n.strong,{children:"are destroyed when your component is disposed"}),". \ud83d\udc4c\ud83c\udffb"]}),"\n",(0,s.jsxs)(n.p,{children:["But in some situations you\u2019ll need to add events to HTML elements outside your components, or even to the global ",(0,s.jsx)(n.code,{children:"window"})," object. In those cases, you will need to make sure that you ",(0,s.jsx)(n.strong,{children:"get rid of these events"})," when your component is disposed. You can do that with ",(0,s.jsx)(n.code,{children:"removeEventListener"}),", and making sure that you keep a reference to the logic as an ",(0,s.jsx)(n.strong,{children:"arrow function"}),". \ud83c\udff9"]}),"\n",(0,s.jsxs)(n.p,{children:["To make sure you don\u2019t forget about ",(0,s.jsx)(n.strong,{children:"getting rid of your events"}),", it\u2019s a good practice to create a ",(0,s.jsx)(n.code,{children:"setupEvents"})," method that allows you to toggle them like this: \ud83d\udc47\ud83c\udffb"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:'import * as THREE from "three";\r\nimport * as OBC from "@thatopen/components";\r\n\r\nclass YourComponent extends Component implements Disposable {\r\n\r\n\t// ...\r\n\r\n\tconstructor() {\r\n\t\tthis.setupEvents(true);\r\n\t}\r\n\r\n\tdispose() {\r\n\t\t// ...\r\n\t\tthis.setupEvents(false);\r\n\t\t// ...\r\n\t}\r\n\r\n\tprivate setupEvents(active: boolean) {\r\n\t\tif(active) {\r\n\t\t\twindow.addEventListener("mousemove", this.logMessage);\r\n\t\t} else {\r\n\t\t\twindow.removeEventListener("mousemove", this.logMessage);\r\n\t\t}\r\n\t}\r\n\r\n\tprivate logMessage = () => {\r\n\t\tconsole.log("Hey!");\r\n\t}\r\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"-huge-objects--arrays",children:"\ud83d\udc18 Huge objects / arrays"}),"\n",(0,s.jsxs)(n.p,{children:["Some components are data-heavy. JavaScript has an automatic garbage collector that should take care of these, but that can take some time. To ",(0,s.jsx)(n.strong,{children:"accelerate this release of memory"}),", you can just assign them an empty value:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-jsx",children:'import * as THREE from "three";\r\nimport * as OBC from "@thatopen/components";\r\n\r\nclass YourComponent extends Component implements Disposable {\r\n\r\n\tdataArray: any = [];\r\n\tdataObject: any = {};\r\n\r\n\tdispose() {\r\n\t\t// ...\r\n\t\tthis.dataArray= [];\r\n\t\tthis.dataObject= {};\r\n\t}\r\n}\n'})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>a});var s=t(6540);const r={},o=s.createContext(r);function i(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);